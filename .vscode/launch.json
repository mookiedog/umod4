// At the moment, debugging is all messed up due to this bug:
// https://github.com/microsoft/vscode-cmake-tools/issues/1485
//
// In short, cmake will not find any executables that are added as subprojects.
// It makes it impossible to select a target and debug it in the normal fashion.

{
  // Use IntelliSense to learn about possible attributes.
  // Hover to view descriptions of existing attributes.
  // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
  "version": "0.2.0",
  "configurations": [
    {
        // This config is here until a VSCode/CMake bug is fixed that allows executables to be found in
        // external projects. Right now, the only way to launch a debug session is to specify the location of
        // the executable file explicitly, as below.
        // Info on the bug is here: https://github.com/microsoft/vscode-cmake-tools/issues/1485
        "name": "*** EP: RP2040 Launch CMSIS-DAP",
        "cwd": "${workspaceRoot}",
        "executable": "${workspaceRoot}/build/EP/EP",
        "request": "launch",
        "type": "cortex-debug",
        "servertype": "openocd",
        "gdbPath" : "/opt/arm/arm-none-eabi/15.2.rel1/bin/arm-none-eabi-gdb",
        "device": "RP2040",
        "configFiles": [
            "interface/cmsis-dap.cfg",
            "target/rp2040.cfg"
        ],
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2040/hardware_regs/RP2040.svd",
        "runToEntryPoint": "main",
        // Work around for stopping at main on restart
        "postRestartCommands": [
            "break main",
            "help", "help",
            "continue"
        ],
        // Debug sessions will not start without setting the adaptor speed as below
        "openOCDLaunchCommands": ["adapter speed 5000"],

        // Configure the rtt IO mechanism to let us use printf for debug/status output
        // To see the output stream, select 'RTT Ch:0 console' in the debugger terminal window
        "rttConfig" : {
            "enabled": true,
            "address": "auto",
            "decoders": [
                {
                    "label": "",
                    "port": 0,
                    "polling_interval": 10,
                    "type": "console",
                    "noprompt": true
                }
            ]
        },
        "liveWatch": {
            "enabled": true,
            "samplesPerSecond": 4
        },
    },
        {
        // SwdReflash: RAM-only program for testing SWD loading
        // This program runs entirely from RAM (no flash)
        // Entry point is at 0x20000101 (Thumb mode), SP at 0x20042000
        "name": "*** RP2040: SwdReflash Launch CMSIS-DAP",
        "cwd": "${workspaceRoot}",
        "executable": "${workspaceRoot}/build/SwdReflash/SwdReflash",
        "request": "launch",
        "type": "cortex-debug",
        "servertype": "openocd",
        "gdbPath" : "/opt/arm/arm-none-eabi/15.2.rel1/bin/arm-none-eabi-gdb",
        "device": "RP2040",
        "configFiles": [
            "interface/cmsis-dap.cfg",
            "target/rp2040.cfg"
        ],
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2040/hardware_regs/RP2040.svd",

        // Debug sessions will not start without setting the adaptor speed as below
        "openOCDLaunchCommands": ["adapter speed 5000"],

        // For RAM-only programs, we need special setup to start execution
        // It is assumed that the program was built to run at 0x20000001
        // and that the vector table sits at 0x20000100!
        "postLaunchCommands": [
            // Program is loaded to RAM by GDB's 'load' command
            // Now set PC and SP for RAM execution
            "set $pc = 0x20000001",
            "set $sp = 0x20042000",
            // Set a breakpoint at main
            "break main",
            // Continue to main
            "continue"
        ],

        // For restarts, need to reload to RAM and reset PC/SP
        "postRestartCommands": [
            "load",
            "set $pc = 0x20000101",
            "set $sp = 0x20042000",
            "break main",
            "continue"
        ],
    },
    {
        // This config is here until a VSCode/CMake bug is fixed that allows executables to be found in
        // external projects. Right now, the only way to launch a debug session is to specify the location of
        // the executable file explicitly, as below.
        // Info on the bug is here: https://github.com/microsoft/vscode-cmake-tools/issues/1485
        "name": "*** WP: RP2350 Launch CMSIS-DAP",
        "cwd": "${workspaceRoot}",
        "executable": "${workspaceRoot}/build/WP/WP.elf",
        "request": "launch",
        "type": "cortex-debug",
        "servertype": "openocd",
        "gdbPath" : "/opt/arm/arm-none-eabi/15.2.rel1/bin/arm-none-eabi-gdb",
        "device": "RP2350",
        "configFiles": [
            "interface/cmsis-dap.cfg",
            "target/rp2350.cfg"
        ],
        // Enabling this next line causes all kinds of trouble, like only showing 1 core, not stopping at breakpoints.
        // Things seem to work fine without it...
        //"rtos": "FreeRTOS",
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2350/hardware_regs/RP2350.svd",
        "runToEntryPoint": "main",
        // Work around for stopping at main on restart
        "postRestartCommands": [
            "break main",
            "help", "help",
            "continue"
            ,"monitor rp2350.core1 arp_reset assert 0 ; rp2350.core0 arp_reset assert 0 ; reset halt"
        ],
        // Debug sessions will not start without setting the adaptor speed as below
        "openOCDLaunchCommands": ["adapter speed 5000"],

        // See: https://forums.raspberrypi.com/viewtopic.php?t=349795
        //"postLaunchCommands": ["monitor rp2040.core1 arp_reset assert 0 ; rp2040.core0 arp_reset assert 0 ; reset halt"],

        // Configure the rtt IO mechanism to let the WP use printf for debug/status output
        // To see the output stream, select 'RTT Ch:0 console' in the debugger terminal window
        "rttConfig" : {
          "enabled": true,
          "address": "auto",
          "decoders": [
              {
                  "label": "",
                  "port": 0,
                  "polling_interval": 10,
                  "type": "console",
                  "noprompt": true
              }
          ]
        },
        "liveWatch": {
            "enabled": true,
            "samplesPerSecond": 4
        },
    },
    {
        // Attach-only config: connects to running WP without flashing
        // Use after BOOTSEL flash to examine boot info without overwriting partition table
        "name": "*** WP: RP2350 Attach (no flash)",
        "cwd": "${workspaceRoot}",
        "executable": "${workspaceRoot}/build/WP/WP.elf",
        "request": "attach",
        "type": "cortex-debug",
        "servertype": "openocd",
        "gdbPath" : "/opt/arm/arm-none-eabi/15.2.rel1/bin/arm-none-eabi-gdb",
        "device": "RP2350",
        "configFiles": [
            "interface/cmsis-dap.cfg",
            "target/rp2350.cfg"
        ],
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2350/hardware_regs/RP2350.svd",
        "openOCDLaunchCommands": ["adapter speed 5000"],
        "rttConfig" : {
          "enabled": true,
          "address": "auto",
          "decoders": [
              {
                  "label": "",
                  "port": 0,
                  "polling_interval": 10,
                  "type": "console",
                  "noprompt": true
              }
          ]
        },
        "liveWatch": {
            "enabled": true,
            "samplesPerSecond": 4
        },
    },
    {
        // Partition-aware debug configuration for WP RP2350
        // This flashes the partition table and app to their correct locations,
        // then uses the ROM bootloader to set up XIP remapping.
        // Use this when debugging code that uses ROM partition functions
        // (rom_get_uf2_target_partition, rom_get_boot_info, etc.)
        //
        // REQUIRES: Run 'ninja partition_table_bin' first (or rebuild all)
        "name": "*** WP: RP2350 Partition-Aware Debug",
        "cwd": "${workspaceRoot}",
        "executable": "${workspaceRoot}/build/WP/WP.elf",
        "request": "launch",
        "type": "cortex-debug",
        "servertype": "openocd",
        "gdbPath" : "/opt/arm/arm-none-eabi/15.2.rel1/bin/arm-none-eabi-gdb",
        "device": "RP2350",
        "configFiles": [
            "interface/cmsis-dap.cfg",
            "target/rp2350.cfg"
        ],
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2350/hardware_regs/RP2350.svd",
        "runToEntryPoint": "main",

        // Debug sessions will not start without setting the adaptor speed
        "openOCDLaunchCommands": ["adapter speed 5000"],

        // CRITICAL: Prevent GDB from loading the ELF to flash!
        // The ELF is linked to 0x10000000, but we need the app at 0x10010000 (slot A).
        // We flash manually via OpenOCD, then GDB just uses the ELF for symbols.
        // The ROM bootloader will remap slot A (0x10010000) to appear at 0x10000000.
        "loadFiles": [],

        // Flash partition table + app to correct locations before running
        "preLaunchCommands": [
            // Halt the CPU first
            "monitor reset halt",
            // Erase slot B first sector to invalidate any old image
            // Slot B starts at sector 520 (boot=16 sectors + A=504 sectors = 520)
            // Sector 520 = 0x10208000
            "monitor flash erase_sector 0 520 520",
            // Flash partition table to boot region (0x10000000)
            "monitor flash write_image erase ${workspaceRoot}/build/WP/partition_table.bin 0x10000000",
            // Flash app to slot A (0x10010000 = boot region + 64K)
            "monitor flash write_image erase ${workspaceRoot}/build/WP/WP.bin 0x10010000",
            // Let ROM bootloader run - it will read partition table and set up XIP remapping
            "monitor reset init"
        ],

        // For restarts, use reset init to let bootloader run again
        "postRestartCommands": [
            "monitor reset init",
            "break main",
            "continue"
        ],

        // Configure RTT for printf output
        "rttConfig" : {
          "enabled": true,
          "address": "auto",
          "decoders": [
              {
                  "label": "",
                  "port": 0,
                  "polling_interval": 10,
                  "type": "console",
                  "noprompt": true
              }
          ]
        },
        "liveWatch": {
            "enabled": true,
            "samplesPerSecond": 4
        },
    },
    {
        // This config is here until a VSCode/CMake bug is fixed that allows executables to be found in
        // external projects. Right now, the only way to launch a debug session is to specify the location of
        // the executable file explicitly, as below.
        // Info on the bug is here: https://github.com/microsoft/vscode-cmake-tools/issues/1485
        "name": "*** WP: RP2040 Launch CMSIS-DAP",
        "cwd": "${workspaceRoot}",
        "executable": "${workspaceRoot}/build/WP/WP",
        "request": "launch",
        "type": "cortex-debug",
        "servertype": "openocd",
        "gdbPath" : "/opt/arm/arm-none-eabi/15.2.rel1/bin/arm-none-eabi-gdb",
        "device": "RP2040",
        "configFiles": [
            "interface/cmsis-dap.cfg",
            "target/rp2040.cfg"
        ],
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2040/hardware_regs/RP2040.svd",
        "runToEntryPoint": "main",
        // Work around for stopping at main on restart
        "postRestartCommands": [
            "break main",
            "help", "help",
            "continue"
        ],
        // Debug sessions will not start without setting the adaptor speed as below
        "openOCDLaunchCommands": ["adapter speed 5000"],

        // Configure the rtt IO mechanism to let the WP use printf for debug/status output
        // To see the output stream, select 'RTT Ch:0 console' in the debugger terminal window
        "rttConfig" : {
          "enabled": true,
          "address": "auto",
          "decoders": [
              {
                  "label": "",
                  "port": 0,
                  "polling_interval": 10,
                  "type": "console",
                  "noprompt": true
              }
          ]
      }
    },
    {
        "cwd": "${workspaceRoot}",
        "executable": "${command:cmake.launchTargetPath}",
        "name": "Debug with JLink/JLink",
        "request": "launch",
        "type": "cortex-debug",
        "device": "RP2040_M0_0",
        "configFiles": [
            "target/rp2040.cfg"
        ],
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2040/hardware_regs/RP2040.svd",
        "runToEntryPoint": "main",
        "showDevDebugOutput": "none",
        "servertype": "jlink",
        // Need to use WSL path! Specifying the cmdline version helps with getting info
        // in the terminal tab when bad things happen:
        "serverpath": "/mnt/c/Program Files/SEGGER/JLink/JLinkGDBServerCL.exe"
    },
    {
        "cwd": "${workspaceRoot}",
        "executable": "${command:cmake.launchTargetPath}",
        "name": "Debug with JLink/OpenOCD",
        "request": "launch",
        "type": "cortex-debug",
        "showDevDebugOutput": "none",
        "servertype": "jlink",
        "gdbPath" : "arm-none-eabi-gdb",
        "device": "RP2040",
        "configFiles": [
            "interface/picoprobe.cfg",
            "target/rp2040.cfg"
        ],
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2040/hardware_regs/RP2040.svd",
        //"runToMain": true,
        //"runToEntryPoint": "main",
        "runToEntryPoint": "platform_entry",
        // Work around for stopping at main on restart
        "postRestartCommands": [
            "break main",
            "help", "help",
            "continue"
        ],
        "searchDir": ["/home/robin/pico/openocd/tcl"],
    },
    {
        // This is the standard RPi PicoProbe solution
        "name": "PicoProbe Launch",
        "cwd": "${workspaceRoot}",
        "executable": "${command:cmake.launchTargetPath}",
        "request": "launch",
        "type": "cortex-debug",
        "servertype": "openocd",
        "gdbPath" : "arm-none-eabi-gdb",
        "device": "RP2040",
        "configFiles": [
            "interface/picoprobe.cfg",
            "target/rp2040.cfg"
        ],
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2040/hardware_regs/RP2040.svd",
        "runToEntryPoint": "main",
        // Work around for stopping at main on restart
        "postRestartCommands": [
            "break main",
            "help", "help",
            "continue"
        ],
        "searchDir": ["/home/robin/pico/openocd/tcl"],
    },
    {
        // This is the standard RPi PicoProbe solution
        "name": "EP PicoProbe Launch",
        "cwd": "${workspaceRoot}",
        "executable": "${workspaceRoot}/build/EP/EP",
        "request": "launch",
        "type": "cortex-debug",
        "servertype": "openocd",
        "gdbPath" : "/opt/arm/arm-none-eabi/15.2.rel1/bin/arm-none-eabi-gdb",
        "device": "RP2040",
        "configFiles": [
            "interface/picoprobe.cfg",
            "target/rp2040.cfg"
        ],
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2040/hardware_regs/RP2040.svd",
        "runToEntryPoint": "main",
        // Work around for stopping at main on restart
        "postRestartCommands": [
            "break main",
            "help", "help",
            "continue"
        ],
        "searchDir": ["/home/robin/pico/openocd/tcl"],
    },
    {
        // This is the standard (old) RPi PicoProbe solution
        "name": "PicoProbe Attach",
        "cwd": "${workspaceRoot}",
        "executable": "${command:cmake.launchTargetPath}",
        "request": "attach",
        "type": "cortex-debug",
        "servertype": "openocd",
        //"serverpath":"/home/robin/pico/openocd/src/gopenocd.exe",
        // This may need to be arm-none-eabi-gdb depending on your system
        "gdbPath" : "arm-none-eabi-gdb",
        "device": "RP2040",
        "configFiles": [
            "interface/picoprobe.cfg",
            "target/rp2040.cfg"
        ],
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2040/hardware_regs/RP2040.svd",
        "runToEntryPoint": "main",
        // Work around for stopping at main on restart
        "postRestartCommands": [
            "break main",
            "help", "help",
            "continue"
        ],
        "searchDir": ["/home/robin/pico/openocd/tcl"],
    },
    {
        // This is the new CMSIS-DAP RPi PicoProbe solution for launch and attach.
        // Remember: to select the target you want to debug, look for [target-name] on the VS Code status bar.
        // Click the [target-name] and it will give you a choice of things you can debug.
        // After selecting something, F5 will work to start debugging the target you chose.
        "name": "Launch CMSIS-DAP",
        "cwd": "${workspaceRoot}",
        "executable": "${command:cmake.launchTargetPath}",
        "request": "launch",
        "type": "cortex-debug",
        "servertype": "openocd",
        "gdbPath" : "arm-none-eabi-gdb",
        "device": "RP2040",
        "configFiles": [
            "interface/cmsis-dap.cfg",
            "target/rp2040.cfg"
        ],
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2040/hardware_regs/RP2040.svd",
        "runToEntryPoint": "main",
        // Work around for stopping at main on restart
        "postRestartCommands": [
            "break main",
            "help", "help",
            "continue"
        ],
        "searchDir": ["/home/robin/pico/openocd/tcl"],
    },
    {
        "name": "Attach CMSIS-DAP",
        "cwd": "${workspaceRoot}",
        "executable": "${command:cmake.launchTargetPath}",
        "request": "attach",
        "type": "cortex-debug",
        "servertype": "openocd",
        "gdbPath" : "arm-none-eabi-gdb",
        "device": "RP2040",
        "configFiles": [
            "interface/cmsis-dap.cfg",
            "target/rp2040.cfg"
        ],
        "svdFile": "${env:PICO_SDK_PATH}/src/rp2040/hardware_regs/RP2040.svd",
        "runToEntryPoint": "main",
        // Work around for stopping at main on restart
        "postRestartCommands": [
            "break main",
            "help", "help",
            "continue"
        ],
        "searchDir": ["/home/robin/pico/openocd/tcl"],
    },
    {
      // This is the "fast" picoprobe replacement that features a minimal GDB server built into the probe
      // See https://forums.raspberrypi.com/viewtopic.php?p=2036136
      "name": "Fast Pico Debug",
      "cwd": "${workspaceRoot}",
      "executable": "${command:cmake.launchTargetPath}",
      "request": "launch",
      "type": "cortex-debug",
      "servertype": "external",
      "gdbPath" : "arm-none-eabi-gdb",
      "gdbTarget" : "/dev/ttyACM0",
      "device": "RP2040",
      "svdFile": "${env:PICO_SDK_PATH}/src/rp2040/hardware_regs/RP2040.svd",

      //"showDevDebugOutput": "raw",

      // runToEntryPoint causes differences in behavour between launch and reset
      // so best avoided for this use case.
      //"runToEntryPoint": "main",

      // breakAfterReset means it consistantly stops in the reset handler code
      // so we can follow that with some commands to get us to main
      "breakAfterReset": true,

      // get_to_main puts a breakpoint at main, gets there, and then remove is
      // immediately after flashing. This means that by the time any ram based
      // breakpoints are applied the relevant stuff is in RAM.
      "postLaunchCommands": [
          "break main", "continue", "help", "help", "clear main",
      ],
      // With breakAfterReset we have a consistent approach so can use the same
      // commands to get us to main after a restart...
      "postRestartCommands": [
          "break main",
          "continue",
          "help",
          "help",
          "clear main"
      ]
   }
  ]
}