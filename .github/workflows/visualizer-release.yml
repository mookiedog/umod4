name: Build and Release Visualizer

on:
  workflow_dispatch:  # Allow manual triggering for testing
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - windows
          - linux
          - macos
  push:
    tags:
      - 'viz-v*'  # Triggers on viz-v1.0.0, viz-v2.1.0, etc.

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    if: |
      github.event_name == 'push' ||
      github.event.inputs.platform == 'all' ||
      github.event.inputs.platform == 'windows'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka pyside6-essentials pyqtgraph numpy pandas h5py pyyaml

      - name: Generate Logsyms package
        shell: bash
        run: |
          set -e  # Exit on any error

          # Generate Logsyms.py from log header files
          echo "Generating Logsyms.py..."
          python tools/src/h2py.py --class-name Logsyms -o Logsyms.py \
            ecu/src/ECU_log.h EP/src/EP_log.h WP/src/WP_log.h

          if [ ! -f Logsyms.py ]; then
            echo "ERROR: Logsyms.py was not generated!"
            exit 1
          fi

          # Find site-packages directory
          SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
          echo "Site-packages directory: $SITE_PACKAGES"

          # Create Logsyms package directory
          mkdir -p "$SITE_PACKAGES/Logsyms"
          cp Logsyms.py "$SITE_PACKAGES/Logsyms/"

          # Create __init__.py
          echo "from .Logsyms import *" > "$SITE_PACKAGES/Logsyms/__init__.py"

          # Verify installation
          echo "Verifying Logsyms installation..."
          python -c "import Logsyms; print('Logsyms module imported successfully')"

      - name: Build with Nuitka
        shell: bash
        env:
          PYTHONPATH: ${{ github.workspace }}/tools/logtools/decoder
        run: |
          cd tools/logtools/viz
          python -m nuitka \
            --onefile \
            --assume-yes-for-downloads \
            --output-dir=../../../build/viz \
            --enable-plugin=pyside6 \
            --include-qt-plugins=iconengines,imageformats,platforms,styles,tls \
            --enable-plugin=numpy \
            --include-package=h5py \
            --include-package=viz_components \
            --include-package-data=viz_components \
            --include-module=Logsyms \
            --include-module=Logsyms.Logsyms \
            --include-module=decodelog \
            --include-module=conversions \
            --include-module=PySide6.QtOpenGL \
            --include-module=PySide6.QtOpenGLWidgets \
            --include-data-files=stream_config.yaml=stream_config.yaml \
            --include-data-files=stream_config.py=stream_config.py \
            --nofollow-import-to=PySide6.QtWebEngineWidgets \
            --nofollow-import-to=h5py.tests \
            --nofollow-import-to=numpy.conftest \
            --follow-imports \
            viz.py

      - name: Create release package
        shell: bash
        run: |
          # Extract version from tag (viz-v1.0.0 -> v1.0.0)
          # If manually triggered (no tag), use "test" as version
          if [[ "$GITHUB_REF" == refs/tags/viz-* ]]; then
            VERSION=${GITHUB_REF#refs/tags/viz-}
          else
            VERSION="test-$(date +%Y%m%d-%H%M%S)"
          fi

          # Create release directory
          mkdir -p release

          # Copy the onefile executable (Nuitka creates viz.exe for onefile mode on Windows)
          if [ -f build/viz/viz.exe ]; then
            cp build/viz/viz.exe release/viz.exe
            chmod +x release/viz.exe
          fi

          # Copy sample log files
          cp tools/logtools/test_data/*.um4 release/ 2>/dev/null || true
          cp tools/logtools/test_data/*.log release/ 2>/dev/null || true

          # Create README
          cat > release/README.txt << 'EOF'
          Data Visualizer $VERSION
          =========================

          QUICK START
          -----------
          1. Double-click viz to launch
          2. Open one of the sample .um4 files to see example data
          3. Use File > Open to load your own .h5 or .um4 log files

          SYSTEM REQUIREMENTS
          -------------------
          - Windows 10 or later / Linux / macOS 10.13+
          - No additional software needed

          SAMPLE FILES
          ------------
          Included .um4 files are raw binary log files. When you open them,
          the visualizer will automatically offer to convert them to HDF5 format.

          GETTING YOUR OWN LOGS
          ---------------------
          1. Extract log files from your umod4 SD card (*.um4 or *.log files)
          2. Open them directly in the visualizer
          3. The visualizer will automatically convert them to HDF5 format

          MORE INFORMATION
          ----------------
          Project: https://github.com/mookiedog/umod4
          Issues: https://github.com/mookiedog/umod4/issues
          EOF

          # Create ZIP archive
          cd release
          7z a ../DataVisualizer-Windows-${VERSION}.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DataVisualizer-Windows-${{ github.ref_name }}
          path: DataVisualizer-Windows-*.zip

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event.inputs.platform == 'all' ||
      github.event.inputs.platform == 'linux'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka pyside6-essentials pyqtgraph numpy pandas h5py pyyaml

      - name: Generate Logsyms package
        shell: bash
        run: |
          set -e  # Exit on any error

          # Generate Logsyms.py from log header files
          echo "Generating Logsyms.py..."
          python tools/src/h2py.py --class-name Logsyms -o Logsyms.py \
            ecu/src/ECU_log.h EP/src/EP_log.h WP/src/WP_log.h

          if [ ! -f Logsyms.py ]; then
            echo "ERROR: Logsyms.py was not generated!"
            exit 1
          fi

          # Find site-packages directory
          SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
          echo "Site-packages directory: $SITE_PACKAGES"

          # Create Logsyms package directory
          mkdir -p "$SITE_PACKAGES/Logsyms"
          cp Logsyms.py "$SITE_PACKAGES/Logsyms/"

          # Create __init__.py
          echo "from .Logsyms import *" > "$SITE_PACKAGES/Logsyms/__init__.py"

          # Verify installation
          echo "Verifying Logsyms installation..."
          python -c "import Logsyms; print('Logsyms module imported successfully')"

      - name: Build with Nuitka
        shell: bash
        env:
          PYTHONPATH: ${{ github.workspace }}/tools/logtools/decoder
        run: |
          cd tools/logtools/viz
          python -m nuitka \
            --onefile \
            --assume-yes-for-downloads \
            --output-dir=../../../build/viz \
            --enable-plugin=pyside6 \
            --include-qt-plugins=iconengines,imageformats,platforms,platformthemes,tls \
            --enable-plugin=numpy \
            --include-package=h5py \
            --include-package=viz_components \
            --include-package-data=viz_components \
            --include-module=Logsyms \
            --include-module=Logsyms.Logsyms \
            --include-module=decodelog \
            --include-module=conversions \
            --include-module=PySide6.QtOpenGL \
            --include-module=PySide6.QtOpenGLWidgets \
            --include-data-files=stream_config.yaml=stream_config.yaml \
            --include-data-files=stream_config.py=stream_config.py \
            --nofollow-import-to=PySide6.QtWebEngineWidgets \
            --nofollow-import-to=h5py.tests \
            --nofollow-import-to=numpy.conftest \
            --follow-imports \
            viz.py

      - name: Create release package
        shell: bash
        run: |
          # Extract version from tag (viz-v1.0.0 -> v1.0.0)
          # If manually triggered (no tag), use "test" as version
          if [[ "$GITHUB_REF" == refs/tags/viz-* ]]; then
            VERSION=${GITHUB_REF#refs/tags/viz-}
          else
            VERSION="test-$(date +%Y%m%d-%H%M%S)"
          fi

          # Create release directory
          mkdir -p release

          # Copy the onefile executable (Nuitka creates viz.bin for onefile mode)
          if [ -f build/viz/viz.bin ]; then
            cp build/viz/viz.bin release/viz
            chmod +x release/viz
          elif [ -f build/viz/viz ]; then
            cp build/viz/viz release/viz
            chmod +x release/viz
          fi

          # Copy sample log files
          cp tools/logtools/test_data/*.um4 release/ 2>/dev/null || true
          cp tools/logtools/test_data/*.log release/ 2>/dev/null || true

          # Create README
          cat > release/README.txt << 'EOF'
          Data Visualizer $VERSION
          =========================

          QUICK START
          -----------
          1. Double-click viz to launch
          2. Open one of the sample .um4 files to see example data
          3. Use File > Open to load your own .h5 or .um4 log files

          SYSTEM REQUIREMENTS
          -------------------
          - Windows 10 or later / Linux / macOS 10.13+
          - No additional software needed

          SAMPLE FILES
          ------------
          Included .um4 files are raw binary log files. When you open them,
          the visualizer will automatically offer to convert them to HDF5 format.

          GETTING YOUR OWN LOGS
          ---------------------
          1. Extract log files from your umod4 SD card (*.um4 or *.log files)
          2. Open them directly in the visualizer
          3. The visualizer will automatically convert them to HDF5 format

          MORE INFORMATION
          ----------------
          Project: https://github.com/mookiedog/umod4
          Issues: https://github.com/mookiedog/umod4/issues
          EOF

          # Create ZIP archive
          cd release
          zip -r ../DataVisualizer-Linux-${VERSION}.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DataVisualizer-Linux-${{ github.ref_name }}
          path: DataVisualizer-Linux-*.zip

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    if: |
      github.event_name == 'push' ||
      github.event.inputs.platform == 'all' ||
      github.event.inputs.platform == 'macos'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka pyside6-essentials pyqtgraph numpy pandas h5py pyyaml

      - name: Generate Logsyms package
        shell: bash
        run: |
          set -e  # Exit on any error

          # Generate Logsyms.py from log header files
          echo "Generating Logsyms.py..."
          python tools/src/h2py.py --class-name Logsyms -o Logsyms.py \
            ecu/src/ECU_log.h EP/src/EP_log.h WP/src/WP_log.h

          if [ ! -f Logsyms.py ]; then
            echo "ERROR: Logsyms.py was not generated!"
            exit 1
          fi

          # Find site-packages directory
          SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
          echo "Site-packages directory: $SITE_PACKAGES"

          # Create Logsyms package directory
          mkdir -p "$SITE_PACKAGES/Logsyms"
          cp Logsyms.py "$SITE_PACKAGES/Logsyms/"

          # Create __init__.py
          echo "from .Logsyms import *" > "$SITE_PACKAGES/Logsyms/__init__.py"

          # Verify installation
          echo "Verifying Logsyms installation..."
          python -c "import Logsyms; print('Logsyms module imported successfully')"

      - name: Build with Nuitka
        shell: bash
        env:
          PYTHONPATH: ${{ github.workspace }}/tools/logtools/decoder
        run: |
          cd tools/logtools/viz
          python -m nuitka \
            --onefile \
            --assume-yes-for-downloads \
            --output-dir=../../../build/viz \
            --enable-plugin=pyside6 \
            --include-qt-plugins=iconengines,imageformats,platforms,styles,tls \
            --enable-plugin=numpy \
            --include-package=h5py \
            --include-package=viz_components \
            --include-package-data=viz_components \
            --include-module=Logsyms \
            --include-module=Logsyms.Logsyms \
            --include-module=decodelog \
            --include-module=conversions \
            --include-module=PySide6.QtOpenGL \
            --include-module=PySide6.QtOpenGLWidgets \
            --include-data-files=stream_config.yaml=stream_config.yaml \
            --include-data-files=stream_config.py=stream_config.py \
            --nofollow-import-to=PySide6.QtWebEngineWidgets \
            --nofollow-import-to=h5py.tests \
            --nofollow-import-to=numpy.conftest \
            --follow-imports \
            viz.py

      - name: Create release package
        shell: bash
        run: |
          # Extract version from tag (viz-v1.0.0 -> v1.0.0)
          # If manually triggered (no tag), use "test" as version
          if [[ "$GITHUB_REF" == refs/tags/viz-* ]]; then
            VERSION=${GITHUB_REF#refs/tags/viz-}
          else
            VERSION="test-$(date +%Y%m%d-%H%M%S)"
          fi

          # Create release directory
          mkdir -p release

          # Copy the onefile executable (Nuitka creates viz.bin for onefile mode)
          if [ -f build/viz/viz.bin ]; then
            cp build/viz/viz.bin release/viz
            chmod +x release/viz
          elif [ -f build/viz/viz ]; then
            cp build/viz/viz release/viz
            chmod +x release/viz
          fi

          # Copy sample log files
          cp tools/logtools/test_data/*.um4 release/ 2>/dev/null || true
          cp tools/logtools/test_data/*.log release/ 2>/dev/null || true

          # Create README
          cat > release/README.txt << 'EOF'
          Data Visualizer $VERSION
          =========================

          QUICK START
          -----------
          1. Double-click viz to launch
          2. Open one of the sample .um4 files to see example data
          3. Use File > Open to load your own .h5 or .um4 log files

          SYSTEM REQUIREMENTS
          -------------------
          - Windows 10 or later / Linux / macOS 10.13+
          - No additional software needed

          SAMPLE FILES
          ------------
          Included .um4 files are raw binary log files. When you open them,
          the visualizer will automatically offer to convert them to HDF5 format.

          GETTING YOUR OWN LOGS
          ---------------------
          1. Extract log files from your umod4 SD card (*.um4 or *.log files)
          2. Open them directly in the visualizer
          3. The visualizer will automatically convert them to HDF5 format

          MORE INFORMATION
          ----------------
          Project: https://github.com/mookiedog/umod4
          Issues: https://github.com/mookiedog/umod4/issues
          EOF

          # Create ZIP archive
          cd release
          zip -r ../DataVisualizer-macOS-${VERSION}.zip *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DataVisualizer-macOS-${{ github.ref_name }}
          path: DataVisualizer-macOS-*.zip

  release:
    name: Create GitHub Release
    needs: [build-windows, build-linux, build-macos]
    if: always() && (needs.build-windows.result == 'success' || needs.build-linux.result == 'success' || needs.build-macos.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/viz-')
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
