name: Build and Release Visualizer

on:
  push:
    tags:
      - 'viz-v*'

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: DataVisualizer.exe
            asset_name: DataVisualizer-Windows
          - os: ubuntu-latest
            artifact_name: DataVisualizer
            asset_name: DataVisualizer-Linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 pyqtgraph numpy pandas h5py pyyaml

      - name: Build with PyInstaller (Windows)
        if: runner.os == 'Windows'
        working-directory: tools/logtools/viz
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller

          $pyArgs = @(
            '--onefile'
            '--windowed'
            '--paths'
            '.'
            '--collect-submodules'
            'viz_components'
            '--add-data'
            'stream_config.py;.'
            '--add-data'
            'stream_config.yaml;.'
            '--add-data'
            '../decoder/decodelog.py;.'
            '--add-data'
            '../decoder/conversions.py;.'
            '--name'
            'DataVisualizer'
            '--clean'
            'viz.py'
          )
          python -m PyInstaller @pyArgs
          $rc = $LASTEXITCODE

          Get-ChildItem -Path .\build\ -Recurse -Filter "warn*.txt" -ErrorAction SilentlyContinue |
            ForEach-Object { Write-Host "---- $_.FullName ----"; Get-Content $_.FullName -TotalCount 400 }
          Write-Host "---- dist contents ----"
          Get-ChildItem -Path .\dist\ -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }

          if ($rc -ne 0) { exit $rc }

      - name: Upload Windows dist artifact
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: DataVisualizer-Windows
          path: tools/logtools/viz/dist/**

      - name: Build with PyInstaller (Linux)
        if: runner.os == 'Linux'
        working-directory: tools/logtools/viz
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller

          set -o pipefail
          python -m PyInstaller --onefile --windowed \
            --paths . \
            --collect-submodules viz_components \
            --add-data "stream_config.py:." \
            --add-data "stream_config.yaml:." \
            --add-data "../decoder/decodelog.py:." \
            --add-data "../decoder/conversions.py:." \
            --name "DataVisualizer" \
            --clean \
            viz.py
          rc=$?
          find . -type f -path "*/build/*" -name "warn*.txt" -print -exec sed -n '1,400p' {} \; || true
          echo "---- dist contents ----"
          ls -la dist || true
          exit $rc

      - name: Upload Linux dist artifact
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: DataVisualizer-Linux
          path: tools/logtools/viz/dist/**

      - name: Create release package
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/viz-}
          mkdir -p release
          if [ "$RUNNER_OS" == "Windows" ]; then
            cp tools/logtools/viz/dist/DataVisualizer.exe release/ || true
          else
            cp tools/logtools/viz/dist/DataVisualizer release/ || true
          fi
          cp tools/logtools/test_data/*.um4 release/ 2>/dev/null || true
          cp tools/logtools/test_data/*.log release/ 2>/dev/null || true

          # create README without heredoc to avoid YAML/heredoc indentation issues
          printf "%s\n" "Data Visualizer $VERSION" "=========================" "" \
            "QUICK START" "-----------" "1. Double-click DataVisualizer to launch" \
            "2. Open one of the sample .um4 files to see example data" \
            "3. Use File > Open to load your own .h5 or .um4 log files" "" \
            "SYSTEM REQUIREMENTS" "-------------------" "- Windows 10 or later / Linux / macOS 10.13+" \
            "- No additional software needed" "" \
            "SAMPLE FILES" "------------" "Included .um4 files are raw binary log files. When you open them," \
            "the visualizer will automatically offer to convert them to HDF5 format." "" \
            "GETTING YOUR OWN LOGS" "---------------------" "1. Extract log files from your umod4 SD card (*.um4 or *.log files)" \
            "2. Open them directly in the visualizer" "3. The visualizer will automatically convert them to HDF5 format" "" \
            "MORE INFORMATION" "----------------" "Project: https://github.com/mookiedog/umod4" \
            "Issues: https://github.com/mookiedog/umod4/issues" > release/README.txt

          cd release
          if [ "$RUNNER_OS" == "Windows" ]; then
            7z a ../${{ matrix.asset_name }}-${VERSION}.zip *
          else
            zip -r ../${{ matrix.asset_name }}-${VERSION}.zip *
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}-${{ github.ref_name }}
          path: ${{ matrix.asset_name }}-*.zip

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```# filepath: .github/workflows/visualizer-release.yml
name: Build and Release Visualizer

on:
  push:
    tags:
      - 'viz-v*'

jobs:
  build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: DataVisualizer.exe
            asset_name: DataVisualizer-Windows
          - os: ubuntu-latest
            artifact_name: DataVisualizer
            asset_name: DataVisualizer-Linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 pyqtgraph numpy pandas h5py pyyaml

      - name: Build with PyInstaller (Windows)
        if: runner.os == 'Windows'
        working-directory: tools/logtools/viz
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller

          $pyArgs = @(
            '--onefile'
            '--windowed'
            '--paths'
            '.'
            '--collect-submodules'
            'viz_components'
            '--add-data'
            'stream_config.py;.'
            '--add-data'
            'stream_config.yaml;.'
            '--add-data'
            '../decoder/decodelog.py;.'
            '--add-data'
            '../decoder/conversions.py;.'
            '--name'
            'DataVisualizer'
            '--clean'
            'viz.py'
          )
          python -m PyInstaller @pyArgs
          $rc = $LASTEXITCODE

          Get-ChildItem -Path .\build\ -Recurse -Filter "warn*.txt" -ErrorAction SilentlyContinue |
            ForEach-Object { Write-Host "---- $_.FullName ----"; Get-Content $_.FullName -TotalCount 400 }
          Write-Host "---- dist contents ----"
          Get-ChildItem -Path .\dist\ -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }

          if ($rc -ne 0) { exit $rc }

      - name: Upload Windows dist artifact
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: DataVisualizer-Windows
          path: tools/logtools/viz/dist/**

      - name: Build with PyInstaller (Linux)
        if: runner.os == 'Linux'
        working-directory: tools/logtools/viz
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller

          set -o pipefail
          python -m PyInstaller --onefile --windowed \
            --paths . \
            --collect-submodules viz_components \
            --add-data "stream_config.py:." \
            --add-data "stream_config.yaml:." \
            --add-data "../decoder/decodelog.py:." \
            --add-data "../decoder/conversions.py:." \
            --name "DataVisualizer" \
            --clean \
            viz.py
          rc=$?
          find . -type f -path "*/build/*" -name "warn*.txt" -print -exec sed -n '1,400p' {} \; || true
          echo "---- dist contents ----"
          ls -la dist || true
          exit $rc

      - name: Upload Linux dist artifact
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: DataVisualizer-Linux
          path: tools/logtools/viz/dist/**

      - name: Create release package
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/viz-}
          mkdir -p release
          if [ "$RUNNER_OS" == "Windows" ]; then
            cp tools/logtools/viz/dist/DataVisualizer.exe release/ || true
          else
            cp tools/logtools/viz/dist/DataVisualizer release/ || true
          fi
          cp tools/logtools/test_data/*.um4 release/ 2>/dev/null || true
          cp tools/logtools/test_data/*.log release/ 2>/dev/null || true

          # create README without heredoc to avoid YAML/heredoc indentation issues
          printf "%s\n" "Data Visualizer $VERSION" "=========================" "" \
            "QUICK START" "-----------" "1. Double-click DataVisualizer to launch" \
            "2. Open one of the sample .um4 files to see example data" \
            "3. Use File > Open to load your own .h5 or .um4 log files" "" \
            "SYSTEM REQUIREMENTS" "-------------------" "- Windows 10 or later / Linux / macOS 10.13+" \
            "- No additional software needed" "" \
            "SAMPLE FILES" "------------" "Included .um4 files are raw binary log files. When you open them," \
            "the visualizer will automatically offer to convert them to HDF5 format." "" \
            "GETTING YOUR OWN LOGS" "---------------------" "1. Extract log files from your umod4 SD card (*.um4 or *.log files)" \
            "2. Open them directly in the visualizer" "3. The visualizer will automatically convert them to HDF5 format" "" \
            "MORE INFORMATION" "----------------" "Project: https://github.com/mookiedog/umod4" \
            "Issues: https://github.com/mookiedog/umod4/issues" > release/README.txt

          cd release
          if [ "$RUNNER_OS" == "Windows" ]; then
            7z a ../${{ matrix.asset_name }}-${VERSION}.zip *
          else
            zip -r ../${{ matrix.asset_name }}-${VERSION}.zip *
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}-${{ github.ref_name }}
          path: ${{ matrix.asset_name }}-*.zip

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}